server {
    listen 80;
    listen [::]:80;
    server_name deaddrop.internal;

    root /var/www/deaddrop;
    index index.html index.php;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location = /upload/ {
        return 302 /webftp/;
    }

    location /webftp/ {
        try_files $uri $uri/ /webftp/index.php?$query_string;
    }

    # Captive portal endpoints
    location = /generate_204 { return 302 http://deaddrop.internal/; }
    location = /hotspot-detect.html { return 302 http://deaddrop.internal/; }
    location = /library/test/success.html { return 302 http://deaddrop.internal/; }
    location = /connecttest.txt { return 302 http://deaddrop.internal/; }
    location = /ncsi.txt { return 302 http://deaddrop.internal/; }
    location = /success.txt { return 302 http://deaddrop.internal/; }
    location = /canonical.html { return 302 http://deaddrop.internal/; }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/PHP_FPM_SOCK;
    }

    client_max_body_size 1024M;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    if ($host !~* "^(deaddrop\.internal|[0-9.]+|\[[0-9a-fA-F:]+\])$") {
        return 301 http://deaddrop.internal$request_uri;
    }

    root /var/www/deaddrop;
    index index.html index.php;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location = /upload/ {
        return 302 /webftp/;
    }

    location /webftp/ {
        try_files $uri $uri/ /webftp/index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/PHP_FPM_SOCK;
    }

    client_max_body_size 1024M;
}
